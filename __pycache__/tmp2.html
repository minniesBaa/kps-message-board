<head>
    <style>.dark {background-color: #262626;color: white;}</style>
    <title>kp's message board: cooperative meows</title>
    <link rel="icon" href="/noalerticon.ico" type="image/x-icon">
    <script>
        let soundBuffer = null
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const postmeowurl = "https://kp.themice.org/meow/post"
        const currentmeowsurl = "https://kp.themice.org/meow/latest.json"
        function meow(){
            const pitch = document.getElementById("pitch");
            fetch(postmeowurl, {
                method: "POST",
                body: JSON.stringify({
                    "pitch":  pitch.value / 10
                })
            });
        }
        function getMeows(){
            fetch(currentmeowsurl).then((res) => {
                if (!res.ok){
                    return;
                }
                const meows = res.json()
                for (const key in meows){
                    const meow = meows[key];
                    const source = audioContext.createBufferSource();
                    source.buffer = soundBuffer;
                    source.playbackRate.value = meow["pitch"];
                    source.connect(audioContext.destination);
                    source.start(meow["in"]);
                }
            })
        }
        function onload(){
            fetch('https://kp.themice.org/meow.mp3')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(decodedBuffer => {
                    soundBuffer = decodedBuffer;
                    playButton.disabled = false;
            })
            setInterval(getMeows, 1000);
        }
        document.addEventListener('DOMContentLoaded', onload);
    </script>
</head>
<body class="dark" style="text-align: center;">
    <h1>kp's message board: cooperative meows</h1>
    <div style="visibility: hidden;">spacer</div>
    <div style="width:50%; outline: 1px solid black; margin: auto;">
        <div style="visibility: hidden;">spacer</div>
        pitch: 
        <input type="range" id="pitch" min="1" max="20" value="10" style="width: 60%;">
        <br>
        <button onclick="meow()">meow!</button>
        <div style="visibility: hidden;">spacer</div>
    </div>
</body>